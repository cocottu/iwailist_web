# Phase 5 実装計画 📋

## 概要

Phase 5では、アプリケーションをさらに実用的にするための高度な機能を実装します。
**効率性を重視**し、実装の依存関係と複雑度を考慮した順序で開発を進めます。

## 実装優先順位と理由

### 🥇 優先度1: データエクスポート/インポート機能
**実装期間**: 2-3時間

**選定理由**:
- ✅ 既存のデータ構造をそのまま活用できる
- ✅ 他の機能への依存が少なく、独立して実装・テスト可能
- ✅ ユーザーにとって重要な機能（データバックアップ）
- ✅ 実装が比較的シンプル

**実装内容**:
- JSON形式でのデータエクスポート
- 贈答品、人物、お返し、リマインダー、画像の一括エクスポート
- JSONファイルからのデータインポート
- データ検証とエラーハンドリング
- 重複チェック機能
- エクスポート/インポート履歴の管理

**技術スタック**:
- File System Access API（ダウンロード）
- FileReader API（アップロード）
- JSON シリアライゼーション
- Base64エンコード（画像データ）

---

### 🥈 優先度2: プッシュ通知機能
**実装期間**: 3-4時間

**選定理由**:
- ✅ 既存のリマインダー機能を拡張する形で実装可能
- ✅ PWA機能（Service Worker）が既に実装済み
- ✅ Web標準APIを使用（外部サービス不要）
- ✅ ユーザー体験の大幅な向上

**実装内容**:
- Web Notifications APIの統合
- Service Workerでの通知処理
- 通知権限の要求UI
- リマインダーの自動通知
- 通知設定管理（オン/オフ、通知時刻）
- バックグラウンド通知（Service Worker）

**技術スタック**:
- Web Notifications API
- Service Worker（既存を拡張）
- Push API（将来のサーバープッシュに備える）
- Notification Triggers API（可能であれば）

**制約事項**:
- ユーザーの通知許可が必要
- HTTPSまたはlocalhostでのみ動作
- ブラウザによって動作が異なる可能性

---

### 🥉 優先度3: 広告表示機能（準備）
**実装期間**: 1-2時間（準備のみ）

**選定理由**:
- ✅ レイアウトとコンポーネントの準備が可能
- ⚠️ Google AdSenseの審査には時間がかかる
- ⚠️ 実際の広告表示は審査後に実装

**実装内容**:
- 広告表示用コンポーネント作成
- 広告配置の最適化（侵入的でない位置）
- AdSenseスクリプト読み込みの準備
- 環境変数での広告ID管理
- 広告ブロック検知（オプション）

**技術スタック**:
- React コンポーネント
- 環境変数（`import.meta.env`）
- AdSense スクリプト（準備のみ）

**⚠️ セキュリティ注意事項**:
- AdSense IDは環境変数で管理
- 本番環境のIDはGitHub Secretsで管理
- ハードコーディング厳禁

**次のステップ**:
1. Google AdSenseに申請
2. サイトの審査を通過
3. 広告コードの取得
4. 本番環境で広告を有効化

---

### 🏅 優先度4: 複数人での共有機能
**実装期間**: 6-8時間

**選定理由**:
- ⚠️ データモデルの大幅な変更が必要
- ⚠️ Firestoreセキュリティルールの変更が必要
- ⚠️ UIの大幅な変更が必要
- ✅ ただし、設計をしっかり行えば実装可能

**実装内容**:
- 共有モデルの設計
  - 贈答品の共有権限管理
  - 読み取り専用・編集可能の権限レベル
  - 共有招待システム
- Firestoreスキーマの拡張
  - `sharedGifts` コレクション
  - `shareInvitations` コレクション
  - `sharedUsers` サブコレクション
- 共有UI
  - 共有設定ページ
  - 招待送信フォーム
  - 共有ユーザー一覧
  - 権限管理UI
- Firestoreセキュリティルールの更新
  - 共有権限のチェック
  - 読み取り/書き込み権限の分離

**技術スタック**:
- Firebase Firestore（スキーマ拡張）
- Firebase Security Rules
- React コンポーネント
- メール通知（オプション）

**データモデル例**:
```typescript
interface SharedGift {
  giftId: string;
  ownerId: string;
  sharedWith: {
    userId: string;
    email: string;
    permission: 'read' | 'write';
    sharedAt: Date;
  }[];
  createdAt: Date;
}

interface ShareInvitation {
  id: string;
  giftId: string;
  fromUserId: string;
  toEmail: string;
  permission: 'read' | 'write';
  status: 'pending' | 'accepted' | 'declined';
  createdAt: Date;
}
```

---

### 🚀 優先度5: OCR/AI解析機能
**実装期間**: 8-10時間（設計＋準備）

**選定理由**:
- ⚠️ 外部APIの統合が必要
- ⚠️ コストの検討が必要
- ⚠️ 複雑度が高い
- ✅ ただし、将来的に非常に有用な機能

**実装内容**:
- OCR機能
  - レシート・招待状の文字認識
  - テキスト抽出
  - 金額・日付・名前の自動抽出
- AI解析機能
  - カテゴリの自動判定
  - お返し金額の推奨
  - 関係性の推測
- 外部API統合の選択肢
  - Google Cloud Vision API（OCR）
  - OpenAI GPT-4 Vision（AI解析）
  - Tesseract.js（ブラウザ内OCR、無料）

**技術スタック**:
- Google Cloud Vision API または Tesseract.js
- OpenAI API（オプション）
- 画像前処理（コントラスト調整など）
- 正規表現（テキスト抽出）

**コスト検討**:
- **Google Cloud Vision API**:
  - 月1,000リクエストまで無料
  - それ以降: $1.50 / 1,000リクエスト
- **Tesseract.js**:
  - 完全無料（ブラウザ内処理）
  - 精度はやや劣る
- **OpenAI GPT-4 Vision**:
  - 有料（従量課金）
  - 高精度

**推奨アプローチ**:
1. Phase 5.5: Tesseract.jsで基本的なOCR実装（無料）
2. Phase 6: ユーザー数が増えたらGoogle Cloud Vision APIに移行

**実装の詳細設計**:
- OCRサービス抽象化レイヤー（プロバイダー切り替え可能）
- 画像前処理パイプライン
- テキスト解析・構造化
- ユーザーによる修正機能
- 学習データの蓄積（将来的な精度向上）

---

## 実装スケジュール

### Week 1
- ✅ Day 1-2: データエクスポート/インポート機能
- ✅ Day 3-4: プッシュ通知機能
- ✅ Day 5: 広告表示機能（準備）

### Week 2（オプション）
- 🔄 Day 1-3: 複数人での共有機能
- 🔄 Day 4-5: OCR/AI解析機能（設計）

---

## 技術的な考慮事項

### セキュリティ
- ✅ 環境変数の適切な使用
- ✅ APIキーのハードコーディング禁止
- ✅ Firestoreセキュリティルールの厳格化
- ✅ XSS/CSRF対策

### パフォーマンス
- ✅ 大量データのエクスポートの最適化
- ✅ 画像のBase64エンコードの効率化
- ✅ Service Workerでのバックグラウンド処理
- ✅ 通知の適切なスケジューリング

### ユーザー体験
- ✅ プログレスバーの表示
- ✅ エラーメッセージの親切な表示
- ✅ 操作のキャンセル機能
- ✅ 確認ダイアログの適切な配置

---

## テスト戦略

### データエクスポート/インポート
- ✅ 大量データのエクスポートテスト
- ✅ 不正なJSONのインポートテスト
- ✅ 重複データのハンドリングテスト
- ✅ 画像データの整合性テスト

### プッシュ通知
- ✅ 通知権限の要求フロー
- ✅ 通知のスケジューリング
- ✅ バックグラウンドでの通知
- ✅ 通知のクリックハンドリング

### 広告表示
- ✅ 広告ブロック時の表示
- ✅ レスポンシブレイアウト
- ✅ パフォーマンスへの影響確認

---

## ドキュメント作成

各機能の実装後に以下のドキュメントを作成：
- ✅ ユーザーガイド
- ✅ 技術仕様書
- ✅ トラブルシューティングガイド
- ✅ API仕様書（必要に応じて）

---

## まとめ

Phase 5では、効率性を重視した順序で実装を進めます：

1. **データエクスポート/インポート**: 最も独立した機能で、実装が容易
2. **プッシュ通知**: 既存機能を拡張する形で実装可能
3. **広告表示**: レイアウトの準備（実際の広告は審査後）
4. **複数人での共有**: データモデル変更が必要で複雑
5. **OCR/AI解析**: 外部API統合が必要で最も複雑

この順序により、早期に実用的な機能をリリースしつつ、段階的に高度な機能を追加できます。

**実装開始日**: 2025-10-26
**想定完了日**: 2025-10-28（優先度1-3）

---

**次のステップ**: 優先度1の「データエクスポート/インポート機能」の実装を開始します。
